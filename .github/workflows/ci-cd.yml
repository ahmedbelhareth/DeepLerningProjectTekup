name: CI/CD Pipeline MLOps

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_training:
        description: 'Lancer le retraining du mod√®le'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.10'
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================
  # JOB 1: Code Quality & Linting
  # ============================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-lint-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-lint-

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy bandit safety

      - name: Run Black (formatting check)
        run: black --check --diff src/ tests/ || true

      - name: Run isort (import sorting check)
        run: isort --check-only --diff src/ tests/ || true

      - name: Run Flake8 (linting)
        run: flake8 src/ tests/ --max-line-length=120 --ignore=E501,W503,E203 || true

      - name: Run Bandit (security check)
        run: bandit -r src/ -ll || true

      - name: Run Safety (dependency vulnerabilities)
        run: safety check -r requirements.txt || true

  # ============================================
  # JOB 2: Unit Tests
  # ============================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-html

      - name: Run unit tests with coverage
        run: |
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=html --html=test-report.html --self-contained-html
        continue-on-error: true

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov/
            test-report.html

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: coverage.xml
          fail_ci_if_error: false

  # ============================================
  # JOB 3: Integration Tests
  # ============================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest httpx

      - name: Run API integration tests
        run: |
          pytest tests/test_api.py -v --tb=short
        continue-on-error: true

  # ============================================
  # JOB 4: Model Validation
  # ============================================
  model-validation:
    name: Model Validation
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate model architecture
        run: |
          python -c "
          from src.models.architecture import CIFAR10ResNet
          model = CIFAR10ResNet(model_name='resnet18', pretrained=False)
          print(f'Model parameters: {model.count_parameters():,}')
          import torch
          x = torch.randn(1, 3, 32, 32)
          y = model(x)
          assert y.shape == (1, 10), f'Expected (1, 10), got {y.shape}'
          print('Model validation passed!')
          "

      - name: Check model file exists
        run: |
          if [ -f "models/best_model.pth" ]; then
            echo "Model file found"
            ls -lh models/best_model.pth
          else
            echo "Model file not found - will need training"
          fi

  # ============================================
  # JOB 5: Build Docker Images
  # ============================================
  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [integration-tests, model-validation]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for API
        id: meta-api
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}-api
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.api
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-api.outputs.tags }}
          labels: ${{ steps.meta-api.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract metadata for Streamlit
        id: meta-streamlit
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}-streamlit
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Streamlit image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.streamlit
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-streamlit.outputs.tags }}
          labels: ${{ steps.meta-streamlit.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # JOB 6: Transfer Learning Validation
  # ============================================
  transfer-learning-validation:
    name: Transfer Learning Validation
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate Transfer Learning module
        run: |
          python -c "
          from src.models.transfer_learning import (
              mixup_data,
              cutmix_data,
              get_stl10_dataloaders,
              transfer_learning_training
          )
          import torch

          # Test MixUp
          x = torch.randn(4, 3, 32, 32)
          y = torch.tensor([0, 1, 2, 3])
          mixed_x, y_a, y_b, lam = mixup_data(x, y)
          assert mixed_x.shape == x.shape, 'MixUp failed'
          print('MixUp validation: OK')

          # Test CutMix
          cut_x, y_a, y_b, lam = cutmix_data(x, y)
          assert cut_x.shape == x.shape, 'CutMix failed'
          print('CutMix validation: OK')

          print('Transfer Learning module validation passed!')
          "

      - name: Check Transfer Learning model exists
        run: |
          if [ -f "models/best_model_transfer_learning.pth" ]; then
            echo "Transfer Learning model found"
            ls -lh models/best_model_transfer_learning.pth
          else
            echo "Transfer Learning model not found - will need training"
          fi

  # ============================================
  # JOB 7: Model Training (Manual Trigger)
  # ============================================
  train-model:
    name: Train Model
    runs-on: ubuntu-latest
    if: github.event.inputs.run_training == 'true'
    needs: code-quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Train model
        run: |
          python -c "
          from src.models.training import train_model
          from src.data.dataset import get_data_loaders
          from src.utils.config import TRAINING_CONFIG

          train_loader, val_loader, _ = get_data_loaders()

          model, history = train_model(
              train_loader=train_loader,
              val_loader=val_loader,
              epochs=5,  # Reduced for CI
              model_name='resnet18',
              pretrained=True
          )
          print('Training completed!')
          "

      - name: Upload trained model
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: models/best_model.pth

  # ============================================
  # JOB 8: Transfer Learning Training (Manual)
  # ============================================
  train-transfer-learning:
    name: Train Transfer Learning
    runs-on: ubuntu-latest
    if: github.event.inputs.run_training == 'true'
    needs: code-quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Train Transfer Learning model
        run: |
          python -c "
          from src.models.transfer_learning import transfer_learning_training

          print('Starting Transfer Learning training...')
          history = transfer_learning_training(
              num_epochs_stl10=2,    # Reduced for CI
              num_epochs_cifar10=5,  # Reduced for CI
              batch_size=128,
              learning_rate=0.001,
              use_mlflow=False
          )
          print('Transfer Learning training completed!')
          "

      - name: Upload Transfer Learning model
        uses: actions/upload-artifact@v4
        with:
          name: transfer-learning-model
          path: models/best_model_transfer_learning.pth

  # ============================================
  # JOB 9: Deploy to Staging
  # ============================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-docker
    if: github.ref == 'refs/heads/develop'
    environment: staging
    steps:
      - name: Deploy notification
        run: |
          echo "Deploying to staging environment..."
          echo "Docker images are available at:"
          echo "  - ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}-api:develop"
          echo "  - ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}-streamlit:develop"

  # ============================================
  # JOB 10: Deploy to Production
  # ============================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-docker
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Deploy notification
        run: |
          echo "Deploying to production environment..."
          echo "Docker images are available at:"
          echo "  - ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}-api:latest"
          echo "  - ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}-streamlit:latest"

  # ============================================
  # JOB 11: Notify Status
  # ============================================
  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [build-docker]
    if: always()
    steps:
      - name: Pipeline Status
        run: |
          echo "=========================================="
          echo "  CI/CD Pipeline Complete"
          echo "=========================================="
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Status: ${{ job.status }}"
          echo "=========================================="
